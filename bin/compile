#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

BUILD_DIR=$1
CACHE_DIR=$2

# Create necessary directories
mkdir -p "$BUILD_DIR/.brave-for-testing/brave-linux64"

# Install curl if not present
apt-get update
apt-get install -y curl

# Add Brave Browser repository
echo "Adding Brave Browser repository..."
curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main" | tee /etc/apt/sources.list.d/brave-browser-release.list

# Install Brave Browser and dependencies
echo "Installing Brave Browser and dependencies..."
apt-get update
apt-get install -y \
    brave-browser \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libatspi2.0-0 \
    libc6 \
    libcairo2 \
    libcups2 \
    libdbus-1-3 \
    libexpat1 \
    libfontconfig1 \
    libgbm1 \
    libgcc1 \
    libglib2.0-0 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libstdc++6 \
    libx11-6 \
    libx11-xcb1 \
    libxcb1 \
    libxcomposite1 \
    libxcursor1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxi6 \
    libxrandr2 \
    libxrender1 \
    libxss1 \
    libxtst6 \
    lsb-release \
    wget \
    xdg-utils

# Copy Brave Browser executable to our custom directory
echo "Copying Brave Browser executable..."
cp /usr/bin/brave-browser "$BUILD_DIR/.brave-for-testing/brave-linux64/brave"

# Create a wrapper script to launch Brave Browser
cat > "$BUILD_DIR/.brave-for-testing/brave-linux64/brave-wrapper" << 'EOF'
#!/bin/bash
export DISPLAY=:99
Xvfb :99 -screen 0 1280x1024x24 > /dev/null 2>&1 &
exec "$(dirname "$0")/brave" "$@"
EOF

chmod +x "$BUILD_DIR/.brave-for-testing/brave-linux64/brave-wrapper"

# Add Brave Browser to the PATH
echo "export PATH=\$PATH:$BUILD_DIR/.brave-for-testing/brave-linux64" >> "$BUILD_DIR/.profile"

echo "Brave Browser installation complete!" 