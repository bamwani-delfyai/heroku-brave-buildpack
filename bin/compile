#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e
set -o pipefail

# debug
# set -x

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BUILDPACK_DIR="$(cd "$(dirname "$0")"; cd ..; pwd)"

function error() {
  echo " !     $*" >&2
  exit 1
}

function topic() {
  echo "-----> $*"
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

topic "Installing Brave Browser"

INSTALL_DIR="$BUILD_DIR/.brave-for-testing"
mkdir -p "$INSTALL_DIR"

# Detect if Brave is already installed
if which brave-browser; then
  error "Brave Browser is already installed. Please remove any other Brave Browser installation."
fi

# Install dependencies first
source "$BUILDPACK_DIR/bin/install-brave-dependencies"

# Add Brave Browser repository
echo "Adding Brave Browser repository" | indent
mkdir -p "$BUILD_DIR/.apt/etc/apt/keyrings"
mkdir -p "$BUILD_DIR/.apt/etc/apt/sources.list.d"

# Download and add the GPG key
curl -fsSL https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg -o "$BUILD_DIR/.apt/etc/apt/keyrings/brave-browser-archive-keyring.gpg"

# Add the repository
echo "deb [signed-by=$BUILD_DIR/.apt/etc/apt/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main" > "$BUILD_DIR/.apt/etc/apt/sources.list.d/brave-browser-release.list"

# Configure apt to use our custom directory
APT_OPTIONS="-o dir::etc=$BUILD_DIR/.apt/etc/apt -o dir::cache=$CACHE_DIR/apt/cache -o dir::state=$CACHE_DIR/apt/state"

# Download Brave Browser package
echo "Downloading Brave Browser package" | indent
mkdir -p "$CACHE_DIR/apt/archives"
apt-get $APT_OPTIONS -y --force-yes -d install --reinstall --no-install-recommends brave-browser

# Install Brave Browser package
echo "Installing Brave Browser package" | indent
for DEB in $(ls -1 $CACHE_DIR/apt/archives/*.deb); do
  echo "Installing $(basename $DEB)" | indent
  dpkg -x $DEB $BUILD_DIR/.apt/
done

# Copy Brave Browser executable to our custom directory
echo "Copying Brave Browser executable" | indent
mkdir -p "$INSTALL_DIR/brave-linux64"
cp "$BUILD_DIR/.apt/usr/bin/brave-browser" "$INSTALL_DIR/brave-linux64/brave"

# Create a wrapper script to launch Brave Browser
cat > "$INSTALL_DIR/brave-linux64/brave-wrapper" << 'EOF'
#!/bin/bash
export DISPLAY=:99
Xvfb :99 -screen 0 1280x1024x24 > /dev/null 2>&1 &
exec "$(dirname "$0")/brave" "$@"
EOF

chmod +x "$INSTALL_DIR/brave-linux64/brave-wrapper"

# Add Brave Browser to the PATH
echo "Adding executables to PATH" | indent
mkdir -p "$BUILD_DIR/.profile.d"
echo "export PATH=\$HOME/.brave-for-testing/brave-linux64:\$PATH" >> "$BUILD_DIR/.profile.d/brave-for-testing.sh"

# Verify the executable is present
export PATH="$BUILD_DIR/.brave-for-testing/brave-linux64:$PATH"
which brave | indent

echo "Brave Browser installation complete" | indent 