#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e
set -o pipefail

# debug
# set -x

# parse and derive params
BUILD_DIR=/app
CACHE_DIR=/cache
ENV_DIR=/env
BUILDPACK_DIR="$(cd "$(dirname "$0")"; cd ..; pwd)"

function error() {
  echo " !     $*" >&2
  exit 1
}

function topic() {
  echo "-----> $*"
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

topic "Installing Brave Browser"

INSTALL_DIR="$BUILD_DIR/.brave-for-testing"
mkdir -p "$INSTALL_DIR"

# Detect if Brave is already installed
if which brave-browser; then
  error "Brave Browser is already installed. Please remove any other Brave Browser installation."
fi

# Install dependencies first
source "$BUILDPACK_DIR/bin/install-brave-dependencies"

# Add Brave Browser repository
echo "Adding Brave Browser repository" | indent
curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main" | tee /etc/apt/sources.list.d/brave-browser-release.list

# Install Brave Browser
echo "Installing Brave Browser" | indent
apt-get update
apt-get install -y brave-browser

# Copy Brave Browser executable to our custom directory
echo "Copying Brave Browser executable" | indent
cp /usr/bin/brave-browser "$INSTALL_DIR/brave-linux64/brave"

# Create a wrapper script to launch Brave Browser
cat > "$INSTALL_DIR/brave-linux64/brave-wrapper" << 'EOF'
#!/bin/bash
export DISPLAY=:99
Xvfb :99 -screen 0 1280x1024x24 > /dev/null 2>&1 &
exec "$(dirname "$0")/brave" "$@"
EOF

chmod +x "$INSTALL_DIR/brave-linux64/brave-wrapper"

# Add Brave Browser to the PATH
echo "Adding executables to PATH" | indent
mkdir -p "$BUILD_DIR/.profile.d"
echo "export PATH=\$HOME/.brave-for-testing/brave-linux64:\$PATH" >> "$BUILD_DIR/.profile.d/brave-for-testing.sh"

# Verify the executable is present
export PATH="$BUILD_DIR/.brave-for-testing/brave-linux64:$PATH"
which brave | indent

echo "Brave Browser installation complete" | indent 